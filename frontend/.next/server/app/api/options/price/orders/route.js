(()=>{var e={};e.id=9854,e.ids=[9854],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},22408:()=>{},27910:e=>{"use strict";e.exports=require("stream")},28450:()=>{},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30305:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=30305,e.exports=r},34631:e=>{"use strict";e.exports=require("tls")},42173:(e,r,t)=>{"use strict";t.d(r,{U:()=>a});var o=t(35323),s=t(99380);async function a(){let e=await (0,s.UL)();return(0,o.createServerClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,{cookies:{get:r=>e.get(r)?.value,set(r,t,o){e.set({name:r,value:t,...o})},remove(r,t){e.set({name:r,value:"",...t})}}})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},52408:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>_,routeModule:()=>c,serverHooks:()=>m,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>f});var o={};t.r(o),t.d(o,{GET:()=>d,POST:()=>u});var s=t(80702),a=t(35095),i=t(12174),n=t(61439),l=t(42173);async function u(e){try{let r=await (0,l.U)(),{data:{user:t},error:o}=await r.auth.getUser();if(o)return console.error("Auth error:",o),n.NextResponse.json({error:"Authentication failed"},{status:401});let s=t?{id:t.id,email:t.email??"demo@example.com"}:{id:"demo-user-id",email:"demo@example.com"};if(console.log("Auth user:",t?"authenticated":"using mock user for testing"),!t)return n.NextResponse.json({error:"Unauthorized - Please log in"},{status:401});let{optionId:a,orderType:i,quantity:u,price:d}=await e.json();if(!a||!i||!u||!d)return n.NextResponse.json({error:"Missing required fields"},{status:400});if(!["buy","sell"].includes(i))return n.NextResponse.json({error:"Invalid order type"},{status:400});let c=null;if(t){let{data:e,error:t}=await r.from("profiles").select("*").eq("id",s.id).single();if(t&&"PGRST116"!==t.code)return console.error("Profile error:",t),n.NextResponse.json({error:"Profile lookup failed"},{status:500});if(!(c=e)){let{data:e,error:t}=await r.from("profiles").insert({id:s.id,username:s.email.split("@")[0],full_name:s.email.split("@")[0],updated_at:new Date().toISOString()}).select().single();if(t)return console.error("Profile creation error:",t),n.NextResponse.json({error:"Failed to create profile"},{status:500});c=e}}let p=null;if(t&&c){let{data:e,error:t}=await r.from("portfolios").select("*").eq("user_id",s.id).single();if(t&&"PGRST116"!==t.code)return console.error("Portfolio error:",t),n.NextResponse.json({error:"Portfolio lookup failed"},{status:500});if(!(p=e)){let{data:e,error:t}=await r.from("portfolios").insert({user_id:s.id,cash_balance:1e4,total_value:1e4}).select().single();if(t)return console.error("Portfolio creation error:",t),n.NextResponse.json({error:"Failed to create portfolio"},{status:500});p=e}}else p={id:"mock-portfolio-id",user_id:s.id,cash_balance:1e4,total_value:1e4,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};if(!p)return n.NextResponse.json({error:"Portfolio not found"},{status:404});let f=u*d*100;if("buy"===i&&p.cash_balance<f)return n.NextResponse.json({error:`Insufficient funds. Required: $${f.toFixed(2)}, Available: $${p.cash_balance.toFixed(2)}`},{status:400});if(!t){console.log("Simulating order for mock user:",{optionId:a,orderType:i,quantity:u,price:d,totalCost:f,currentBalance:p.cash_balance});let e="buy"===i?p.cash_balance-f:p.cash_balance+f;return n.NextResponse.json({success:!0,order:{id:"mock-order-"+Date.now(),user_id:s.id,option_id:a,order_type:i,quantity:u,price:d,status:"filled",total_cost:f,created_at:new Date().toISOString()},newBalance:e,message:"Order simulated successfully (demo mode)",profile:c?{username:c.username,full_name:c.full_name}:null})}try{let{data:e,error:t}=await r.from("orders").insert({user_id:s.id,option_id:a,order_type:i,quantity:u,price:d,status:"filled",total_cost:f}).select().single();if(t)throw console.error("Order creation error:",t),Error(`Failed to create order: ${t.message}`);let o="buy"===i?p.cash_balance-f:p.cash_balance+f,{error:l}=await r.from("portfolios").update({cash_balance:o,total_value:o,updated_at:new Date().toISOString()}).eq("user_id",s.id);if(l)throw console.error("Portfolio update error:",l),Error(`Failed to update portfolio: ${l.message}`);if("buy"===i){let{data:e,error:t}=await r.from("positions").select("*").eq("user_id",s.id).eq("option_id",a).is("closed_at",null).single();if(t&&"PGRST116"!==t.code)throw console.error("Position lookup error:",t),Error(`Failed to lookup position: ${t.message}`);if(e){let t=e.quantity+u,o=(e.average_cost*e.quantity+d*u)/t,{error:s}=await r.from("positions").update({quantity:t,average_cost:o,current_value:t*d*100,updated_at:new Date().toISOString()}).eq("id",e.id);if(s)throw console.error("Position update error:",s),Error(`Failed to update position: ${s.message}`)}else{let{error:e}=await r.from("positions").insert({user_id:s.id,option_id:a,quantity:u,average_cost:d,current_value:u*d*100});if(e)throw console.error("Position creation error:",e),Error(`Failed to create position: ${e.message}`)}}return n.NextResponse.json({success:!0,order:e,newBalance:o,message:"Order processed successfully",profile:c?{username:c.username,full_name:c.full_name,avatar_url:c.avatar_url}:null})}catch(e){return console.error("Database operation failed:",e),n.NextResponse.json({error:"Database operation failed",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}catch(e){return console.error("Error processing order:",e),n.NextResponse.json({error:"Failed to process order",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function d(){return n.NextResponse.json({error:"Method not allowed"},{status:405})}let c=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/options/price/orders/route",pathname:"/api/options/price/orders",filename:"route",bundlePath:"app/api/options/price/orders/route"},resolvedPagePath:"/workspaces/virtual-options-desk/frontend/src/app/api/options/price/orders/route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:p,workUnitAsyncStorage:f,serverHooks:m}=c;function _(){return(0,i.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:f})}},54451:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},58856:()=>{},59249:e=>{"use strict";e.exports=require("http")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[5143,4352,6568,9380,5323],()=>t(52408));module.exports=o})();